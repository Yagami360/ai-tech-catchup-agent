name: AI Tech Catchup Agent with Claude Code Actions

on:
  workflow_dispatch:
  schedule:
    # 毎週金曜日 9:00 (UTC)
    - cron: '0 9 * * 5'

jobs:
  ai-tech-catchup-claude-code:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: |
            --system-prompt "AI Tech Catchup Agentとして動作してください。

            以下の手順でレポートを作成してください：
            1. prompts/default.yaml の default_search プロンプトを参照
            2. そのプロンプトの内容に従ってWeb検索機能を活用
            3. プロンプトで指定された形式でレポートを作成

            必ず日本語で回答し、具体的で検証可能な情報を提供してください。"

      - name: Create GitHub Issue with Claude Response
        run: |
          echo "📝 GitHub Issueを作成中..."

          # Claude Codeの出力を取得
          if [ -f "claude_output.md" ]; then
            REPORT_CONTENT=$(cat claude_output.md)
          else
            # フォールバック: エラーメッセージ
            REPORT_CONTENT="Claude Codeの実行結果を取得できませんでした。ワークフローの実行を確認してください。"
          fi

          # Issueのタイトルを生成
          TITLE="🤖 AI Tech Catchup Report - $(date '+%Y-%m-%d')"

          # GitHub Issueを作成
          gh issue create \
            --title "$TITLE" \
            --body "## $TITLE

          - **実行日時**: $(date '+%Y年%m月%d日 %H:%M')

          ---

          $REPORT_CONTENT

          ---

          *このレポートは Claude Code Actions によって自動生成されました。*" \
            --repo ${{ github.repository }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create summary
        if: always()
        run: |
          echo "## 🤖 Claude Code Actions Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **実行日時**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **リポジトリ**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ワークフロー**: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "- **実行結果**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **使用モデル**: claude-3-5-sonnet-20241022" >> $GITHUB_STEP_SUMMARY
