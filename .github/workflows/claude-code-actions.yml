name: AI Tech Catchup Agent with Claude Code Actions

on:
  workflow_dispatch:
  schedule:
    # æ¯Žé€±é‡‘æ›œæ—¥ 9:00 (UTC)
    - cron: '0 9 * * 5'

jobs:
  ai-tech-catchup-claude-code:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: |
            --system-prompt "AI Tech Catchup Agentã¨ã—ã¦å‹•ä½œã—ã¦ãã ã•ã„ã€‚

            ä»¥ä¸‹ã®æ‰‹é †ã§ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š
            1. prompts/default.yaml ã® default_search ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å‚ç…§
            2. ãã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å†…å®¹ã«å¾“ã£ã¦Webæ¤œç´¢æ©Ÿèƒ½ã‚’æ´»ç”¨
            3. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§æŒ‡å®šã•ã‚ŒãŸå½¢å¼ã§ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆ

            å¿…ãšæ—¥æœ¬èªžã§å›žç­”ã—ã€å…·ä½“çš„ã§æ¤œè¨¼å¯èƒ½ãªæƒ…å ±ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚"

      - name: Create GitHub Issue with Claude Response
        run: |
          echo "ðŸ“ GitHub Issueã‚’ä½œæˆä¸­..."

          # Claude Codeã®å‡ºåŠ›ã‚’å–å¾—
          if [ -f "claude_output.md" ]; then
            REPORT_CONTENT=$(cat claude_output.md)
          else
            # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            REPORT_CONTENT="Claude Codeã®å®Ÿè¡Œçµæžœã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
          fi

          # Issueã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’ç”Ÿæˆ
          TITLE="ðŸ¤– AI Tech Catchup Report - $(date '+%Y-%m-%d')"

          # GitHub Issueã‚’ä½œæˆ
          gh issue create \
            --title "$TITLE" \
            --body "## $TITLE

          - **å®Ÿè¡Œæ—¥æ™‚**: $(date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M')

          ---

          $REPORT_CONTENT

          ---

          *ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã¯ Claude Code Actions ã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚*" \
            --repo ${{ github.repository }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create summary
        if: always()
        run: |
          echo "## ðŸ¤– Claude Code Actions Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **å®Ÿè¡Œæ—¥æ™‚**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒªãƒã‚¸ãƒˆãƒª**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å®Ÿè¡Œçµæžœ**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ä½¿ç”¨ãƒ¢ãƒ‡ãƒ«**: claude-3-5-sonnet-20241022" >> $GITHUB_STEP_SUMMARY
