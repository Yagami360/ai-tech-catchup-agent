name: AI Tech Catchup with Claude Code Actions

on:
  workflow_dispatch:
  schedule:
    # 毎週金曜日 9:00 (UTC)
    - cron: '0 9 * * 5'

jobs:
  ai-tech-catchup-claude-code:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Claude Code
        uses: anthropic/claude-code-action@v1
        with:
          claude_token: ${{ secrets.CLAUDE_TOKEN }}
          working_directory: '.'
          model: 'claude-3-5-sonnet-20241022'

      - name: Run AI Tech Catchup (make run equivalent)
        run: |
          echo "🤖 AI Tech Catchup Agent - Claude Code Actions"
          echo "=============================================="
          echo "📊 最新AI技術動向レポートを生成中..."

          claude-code run --prompt "
          AI Tech Catchup Agent の最新AI技術動向レポートを生成してください。

          ## 実行条件
          - 現在の日付: $(date '+%Y年%m月%d日')
          - 言語: 日本語

          ## プロンプトファイルを参照
          prompts/default.yaml の default_search セクションのプロンプトを使用して、
          Web検索機能を活用して最新のAI技術動向レポートを作成してください。

          ## 出力形式
          - 詳細なレポート内容
          - 各情報源のURL
          - 具体的な事例と数値データ
          - 開発者向けポイント
          - AI研究者向けポイント
          - SNS・コミュニティ動向
          - OSS動向
          "

      - name: Create GitHub Issue
        run: |
          echo "📝 GitHub Issueを作成中..."

          # Claude Codeの出力を取得
          REPORT_CONTENT=$(cat claude-code-output.md 2>/dev/null || echo "レポートの生成に失敗しました")

          # Issueのタイトルを生成
          TITLE="🤖 AI Tech Catchup Report - $(date '+%Y-%m-%d')"

          # GitHub Issueを作成
          gh issue create \
            --title "$TITLE" \
            --body "## $TITLE

          - **実行日時**: $(date '+%Y年%m月%d日 %H:%M')
          - **使用モデル**: claude-3-5-sonnet-20241022
          - **ワークフロー**: ${{ github.workflow }}

          ---

          $REPORT_CONTENT

          ---

          *このレポートは Claude Code Actions によって自動生成されました。*" \
            --label "ai-report,claude-code" \
            --repo ${{ github.repository }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create summary
        if: always()
        run: |
          echo "## 🤖 Claude Code Actions Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **実行日時**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **リポジトリ**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ワークフロー**: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "- **実行結果**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **使用モデル**: claude-3-5-sonnet-20241022" >> $GITHUB_STEP_SUMMARY
